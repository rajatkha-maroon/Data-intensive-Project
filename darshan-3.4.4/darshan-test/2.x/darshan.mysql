#
# Darshan Database Descriptoin
#

#
# Darshan Job Records
#
create table darshan_job_surveyor
(
#   Column                        Type                Constraint    Comment
    jobid                         int unsigned        not null      comment 'Cobalt job id',
    user                          varchar (8)         not null      comment 'username of user running the job',
    version_string                varchar (10)        not null      comment 'Darshan log version',
    cmdline                       text                not null      comment 'Command line given to mpirun',
    uid                           int                 not null      comment 'Numerical user id',
    start_time                    int                 not null      comment 'Unix time job started running',
    end_time                      int                 not null      comment 'Unix time job stopped running',
    nprocs                        int                 not null      comment 'Number of processors job used',

#   Table Contraints
    constraint primary key(jobid, start_time)
);

#
# Darshan File Records
#
create table darshan_file_surveyor
(
#   Column                        Type                Constraint    Comment
    jobid                         int unsigned        not null      comment 'Cobalt job id',
    start_time                    int                 not null      comment 'Unix time job started running',
    hash                          bigint              not null      comment 'Hash of path and filename',
    rank                          bigint              not null      comment 'Rank of process that accessed file or -1 for all procs',
    name_suffix                   varchar (11)        not null      comment 'Last 11 charaters of filename',
    mpi_indep_opens               bigint              not null      comment 'Count of MPI independent opens',
    mpi_coll_opens                bigint              not null      comment 'Count of MPI collective opens',
    mpi_indep_reads               bigint              not null      comment 'Count of independent MPI reads',
    mpi_indep_writes              bigint              not null      comment 'Count of independent MPI writes',
    mpi_coll_reads                bigint              not null      comment 'Count of collective MPI reads',
    mpi_coll_writes               bigint              not null      comment 'Count of collective MPI writes',
    mpi_split_reads               bigint              not null      comment 'Count of split reads',
    mpi_split_writes              bigint              not null      comment 'Count of split writes',
    mpi_nb_reads                  bigint              not null      comment 'Count of nonblocking MPI reads',
    mpi_nb_writes                 bigint              not null      comment 'Count of nonblocking MPI writes',
    syncs                         bigint              not null      comment 'Count of syncs',
    posix_reads                   bigint              not null      comment 'Count of posix reads',
    posix_writes                  bigint              not null      comment 'Count of posix writes',
    posix_opens                   bigint              not null      comment 'Count of posix opens',
    posix_seeks                   bigint              not null      comment 'Count of posix seeks',
    posix_stats                   bigint              not null      comment 'Count of posix stat/istat/fstats',
    posix_mmaps                   bigint              not null      comment 'Count of posix mmaps',
    posix_freads                  bigint              not null      comment 'Count of posix freads',
    posix_fwrites                 bigint              not null      comment 'Count of posix fwrites',
    posix_fopens                  bigint              not null      comment 'Count of posix fopens',
    posix_fseeks                  bigint              not null      comment 'Count of posix fseeks',
    posix_fsyncs                  bigint              not null      comment 'Count of posix fsyncs',
    posix_fdsyncs                 bigint              not null      comment 'Count of posix fdsyncs',
    nc_indep_opens                bigint              not null      comment 'Count of NetCDF independent opens',
    nc_coll_opens                 bigint              not null      comment 'Count of NetCDF collective opens',
    hdf5_opens                    bigint              not null      comment 'Count of HDF5 opens',
    mpi_combiner_named            bigint              not null      comment 'Count of each MPI datatype category',
    mpi_combiner_dup              bigint              not null      comment 'Count of duped MPI datatypes',
    mpi_combiner_contiguous       bigint              not null      comment 'Count of contiguous MPI datatypes',
    mpi_combiner_vector           bigint              not null      comment 'Count of vectored MPI datatypes',
    mpi_combiner_hvector_integer  bigint              not null      comment 'Count of hvector MPI datatypes',
    mpi_combiner_hvector          bigint              not null      comment 'Count of hvector MPI datatypes',
    mpi_combiner_indexed          bigint              not null      comment 'Count of indexed MPI datatypes',
    mpi_combiner_hindexed_integer bigint              not null      comment 'Count of hindex MPI datatypes',
    mpi_combiner_hindexed         bigint              not null      comment 'Count of hindex MPI datatypes',
    mpi_combiner_indexed_block    bigint              not null      comment 'Count of indexed block MPI datatypes',
    mpi_combiner_struct_integer   bigint              not null      comment 'Count of struct PMI datatypes',
    mpi_combiner_struct           bigint              not null      comment 'Count of struct MPI datatypes',
    mpi_combiner_subarray         bigint              not null      comment 'Count of subarray MPI datatypes',
    mpi_combiner_darray           bigint              not null      comment 'Count of darray MPI datatypes',
    mpi_combiner_f90_real         bigint              not null      comment 'Count of F90 real MPI datatypes',
    mpi_combiner_f90_complex      bigint              not null      comment 'Count of F90 complex MPI datatypes',
    mpi_combiner_f90_integer      bigint              not null      comment 'Count of F90 integer MPI datatypes',
    mpi_combiner_resized          bigint              not null      comment 'Count of resized MPI datatypes',
    mpi_hints                     bigint              not null      comment 'Count of MPI hints used',
    mpi_views                     bigint              not null      comment 'Count of MPI set view calls',
    mode                          bigint              not null      comment 'Mode of file',
    bytes_read                    bigint              not null      comment 'Total bytes read',
    bytes_written                 bigint              not null      comment 'Total byets written',
    max_byte_read                 bigint              not null      comment 'Highest offset byte read',
    max_byte_written              bigint              not null      comment 'Highest offset byte written',
    consec_reads                  bigint              not null      comment 'Count of consecutive reads',
    consec_writes                 bigint              not null      comment 'Count of consecutive writes',
    seq_reads                     bigint              not null      comment 'Count of sequential reads',
    seq_writes                    bigint              not null      comment 'Count of sequential writes',
    rw_switches                   bigint              not null      comment 'Number of times switched between read and write',
    mem_not_aligned               bigint              not null      comment 'Count of accesses not mem aligned',
    mem_alignment                 bigint              not null      comment 'Memory alignment in bytes',
    file_not_aligned              bigint              not null      comment 'Count of accesses not file aligned',
    file_alignment                bigint              not null      comment 'File alignment in bytes',
    max_read_time_size            bigint              not null      comment 'Size of read that took the maximum amount of time to complete',
    max_write_time_size           bigint              not null      comment 'Size of write that took the maximum amount of time to complete',
    size_read_0_100               bigint              not null      comment 'Count of posix read size in range    0 <= x <= 100',
    size_read_100_1K              bigint              not null      comment 'Count of posix read size in range  100  < x <= 1k',
    size_read_1K_10K              bigint              not null      comment 'Count of posix read size in range   1k  < x <= 10k',
    size_read_10K_100K            bigint              not null      comment 'Count of posix read size in range  10k  < x <= 100k',
    size_read_100K_1M             bigint              not null      comment 'Count of posix read size in range 100k  < x <= 1M',
    size_read_1M_4M               bigint              not null      comment 'Count of posix read size in range   1M  < x <= 4M',
    size_read_4M_10M              bigint              not null      comment 'Count of posix read size in reange  4M  < x <= 10M',
    size_read_10M_100M            bigint              not null      comment 'Count of posix read size in range  10M  < x <= 100M',
    size_read_100M_1G             bigint              not null      comment 'Count of posix read size in range 100M  < x <= 1G',
    size_read_1G_plus             bigint              not null      comment 'Count of posix read size in range   1G  < x',
    size_write_0_100              bigint              not null      comment 'Count of posix write sizes in range    0 <= x < 100',
    size_write_100_1K             bigint              not null      comment 'Count of posix write sizes in range  100  < x < 1k',
    size_write_1K_10K             bigint              not null      comment 'Count of posix write sizes in range   1k  < x < 10k',
    size_write_10K_100K           bigint              not null      comment 'Count of posix write sizes in range  10k  < x < 100k',
    size_write_100K_1M            bigint              not null      comment 'Count of posix write sizes in range 100k  < x < 1M',
    size_write_1M_4M              bigint              not null      comment 'Count of posix write sizes in range   1M  < x < 4M',
    size_write_4M_10M             bigint              not null      comment 'Count of posix write sizes in reange  4M  < x < 10M',
    size_write_10M_100M           bigint              not null      comment 'Count of posix write sizes in range  10M  < x < 100M',
    size_write_100M_1G            bigint              not null      comment 'Count of posix write sizes in range 100M  < x < 1G',
    size_write_1G_plus            bigint              not null      comment 'Count of posix write sizes in range   1G  < x',
    size_read_agg_0_100           bigint              not null      comment 'Count of mpi read size in range    0 <= x < 100',
    size_read_agg_100_1K          bigint              not null      comment 'Count of mpi read size in range  100  < x < 1k',
    size_read_agg_1K_10K          bigint              not null      comment 'Count of mpi read size in range   1k  < x < 10k',
    size_read_agg_10K_100K        bigint              not null      comment 'Count of mpi read size in range  10k  < x < 100k',
    size_read_agg_100K_1M         bigint              not null      comment 'Count of mpi read size in range 100k  < x < 1M',
    size_read_agg_1M_4M           bigint              not null      comment 'Count of mpi read size in range   1M  < x < 4M',
    size_read_agg_4M_10M          bigint              not null      comment 'Count of mpi read size in reange  4M  < x < 10M',
    size_read_agg_10M_100M        bigint              not null      comment 'Count of mpi read size in range  10M  < x < 100M',
    size_read_agg_100M_1G         bigint              not null      comment 'Count of mpi read size in range 100M  < x < 1G',
    size_read_agg_1G_plus         bigint              not null      comment 'Count of mpi read size in range   1G  < x',
    size_write_agg_0_100          bigint              not null      comment 'Count of mpi write sizes in range    0 <= x < 100',
    size_write_agg_100_1K         bigint              not null      comment 'Count of mpi write sizes in range  100  < x < 1k',
    size_write_agg_1K_10K         bigint              not null      comment 'Count of mpi write sizes in range   1k  < x < 10k',
    size_write_agg_10K_100K       bigint              not null      comment 'Count of mpi write sizes in range  10k  < x < 100k',
    size_write_agg_100K_1M        bigint              not null      comment 'Count of mpi write sizes in range 100k  < x < 1M',
    size_write_agg_1M_4M          bigint              not null      comment 'Count of mpi write sizes in range   1M  < x < 4M',
    size_write_agg_4M_10M         bigint              not null      comment 'Count of mpi write sizes in reange  4M  < x < 10M',
    size_write_agg_10M_100M       bigint              not null      comment 'Count of mpi write sizes in range  10M  < x < 100M',
    size_write_agg_100M_1G        bigint              not null      comment 'Count of mpi write sizes in range 100M  < x < 1G',
    size_write_agg_1G_plus        bigint              not null      comment 'Count of mpi write sizes in range   1G  < x',
    extent_read_0_100             bigint              not null      comment 'Count of mpi read extents in range    0 <= x < 100',
    extent_read_100_1K            bigint              not null      comment 'Count of mpi read extents in range  100  < x < 1k',
    extent_read_1K_10K            bigint              not null      comment 'Count of mpi read extents in range   1k  < x < 10k',
    extent_read_10K_100K          bigint              not null      comment 'Count of mpi read extents in range  10k  < x < 100k',
    extent_read_100K_1M           bigint              not null      comment 'Count of mpi read extents in range 100k  < x < 1M',
    extent_read_1M_4M             bigint              not null      comment 'Count of mpi read extents in range   1M  < x < 4M',
    extent_read_4M_10M            bigint              not null      comment 'Count of mpi read extents in reange  4M  < x < 10M',
    extent_read_10M_100M          bigint              not null      comment 'Count of mpi read extents in range  10M  < x < 100M',
    extent_read_100M_1G           bigint              not null      comment 'Count of mpi read extents in range 100M  < x < 1G',
    extent_read_1G_plus           bigint              not null      comment 'Count of mpi read extents in range   1G  < x',
    extent_write_0_100            bigint              not null      comment 'Count of mpi write extents in range    0 <= x < 100',
    extent_write_100_1K           bigint              not null      comment 'Count of mpi write extents in range  100  < x < 1k',
    extent_write_1K_10K           bigint              not null      comment 'Count of mpi write extents in range   1k  < x < 10k',
    extent_write_10K_100K         bigint              not null      comment 'Count of mpi write extents in range  10k  < x < 100k',
    extent_write_100K_1M          bigint              not null      comment 'Count of mpi write extents in range 100k  < x < 1M',
    extent_write_1M_4M            bigint              not null      comment 'Count of mpi write extents in range   1M  < x < 4M',
    extent_write_4M_10M           bigint              not null      comment 'Count of mpi write extents in reange  4M  < x < 10M',
    extent_write_10M_100M         bigint              not null      comment 'Count of mpi write extents in range  10M  < x < 100M',
    extent_write_100M_1G          bigint              not null      comment 'Count of mpi write extents in range 100M  < x < 1G',
    extent_write_1G_plus          bigint              not null      comment 'Count of mpi write extents in range   1G  < x',
    write_stride1_stride          bigint              not null      comment 'The most frequent strided access size',
    write_stride2_stride          bigint              not null      comment 'The 2nd most frequent strided access size',
    write_stride3_stride          bigint              not null      comment 'The 3rd most frequent strided access size',
    write_stride4_stride          bigint              not null      comment 'The 4th most frequent strided access size',
    write_stride1_count           bigint              not null      comment 'The count of the stride1 accesses',
    write_stride2_count           bigint              not null      comment 'The count of the stride2 accesses',
    write_stride3_count           bigint              not null      comment 'The count of the stride3 accesses',
    write_stride4_count           bigint              not null      comment 'The count of the stride4 accesses',
    access1_access                bigint              not null      comment 'The most frequent access size',
    access2_access                bigint              not null      comment 'The 2nd most frequent access size',
    access3_access                bigint              not null      comment 'The 3rd most frequent access size',
    access4_access                bigint              not null      comment 'The 4th most frequent access size',
    access1_count                 bigint              not null      comment 'The count of access1 size',
    access2_count                 bigint              not null      comment 'The count of access2 size',
    access3_count                 bigint              not null      comment 'The count of access3 size',
    access4_count                 bigint              not null      comment 'The count of access4 size',
    device                        bigint              not null      comment 'Device of filesystem the file resides on',
    size_at_open                  bigint              not null      comment 'File size at open',
    open_timestamp                double              not null      comment 'Timestamp of first open',
    read_start_timestamp          double              not null      comment 'Timestamp of first read',
    write_start_timestamp         double              not null      comment 'Timestamp of first write',
    close_timestamp               double              not null      comment 'Timestamp of last close',
    read_end_timestamp            double              not null      comment 'Timestamp of last read',
    write_end_timestamp           double              not null      comment 'Timestamp of last write',
    posix_read_time               double              not null      comment 'Cumulative posix read time (seconds)',
    posix_write_time              double              not null      comment 'Cumulative posix write time (seconds)',
    posix_meta_time               double              not null      comment 'Cumulative posix meta time (seconds)',
    mpi_meta_time                 double              not null      comment 'Cumulative MPI meta time (seconds)',
    mpi_read_time                 double              not null      comment 'Cumulative MPI read time (seconds)',
    mpi_write_time                double              not null      comment 'Cumulative MPI write time (seconds)',
    max_read_time                 double              not null      comment 'Time of the maximum read (seconds)',
    max_write_time                double              not null      comment 'Time of the maximum write (seconds)',

#   Table Contraints
    constraint primary key(jobid, start_time, hash, rank),
    constraint foreign key(jobid, start_time) references darshan_job_surveyor(jobid, start_time) on delete cascade
);

#
# Darshan Mount Points
#  for determining which file used which file systems
#
create table darshan_mountpoints_surveyor
(
#   Column                        Type                Constraint    Comment
    jobid                         int unsigned        not null      comment 'Cobalt job id',
    start_time                    int                 not null      comment 'Unix time job started running',
    device                        bigint              not null      comment 'Device of filesystem',
    mountpoint                    text                not null      comment 'Mount point (string)',
    fstype                        text                not null      comment 'File system type (string)',

#   Table Contraints
    constraint primary key(jobid, start_time, device),
    constraint foreign key(jobid, start_time) references darshan_job_surveyor(jobid, start_time) on delete cascade
);
